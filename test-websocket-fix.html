<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-button { background: #007bff; color: white; padding: 10px 20px; border: none; margin: 5px; cursor: pointer; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; }
        .status { padding: 5px 10px; margin: 5px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    <div>
        <button class="test-button" onclick="testSocketConnection()">Test Socket Connection</button>
        <button class="test-button" onclick="testSessionBridge()">Test Session Bridge</button>
        <button class="test-button" onclick="debugAuth()">Debug Authentication</button>
        <button class="test-button" onclick="clearLogs()">Clear Logs</button>
    </div>
    <div id="status" class="status" style="display: none;"></div>
    <div class="log" id="log"></div>

    <script>
        const logs = [];
        const originalConsole = { log: console.log, error: console.error, warn: console.warn };

        function addLog(level, ...args) {
            logs.push({ level, message: args.join(' ') });
            originalConsole[level](...args);
            updateLogDisplay();
        }

        console.log = (...args) => addLog('log', ...args);
        console.error = (...args) => addLog('error', ...args);
        console.warn = (...args) => addLog('warn', ...args);

        function updateLogDisplay() {
            const logContainer = document.getElementById('log');
            logContainer.innerHTML = logs.map(log =>
                `<div class="${log.level}">${new Date().toLocaleTimeString()}: ${log.message}</div>`
            ).join('');
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function clearLogs() {
            logs.length = 0;
            updateLogDisplay();
        }

        async function testSocketConnection() {
            showStatus('Testing WebSocket connection...', 'info');

            try {
                console.log('üîå Testing WebSocket connection...');

                // First, test if the server is responding to HTTP requests
                console.log('üîç Testing HTTP connectivity...');
                try {
                    const response = await fetch('http://localhost:8002/', {
                        method: 'GET',
                        timeout: 5000
                    });
                    console.log('‚úÖ HTTP server is responding:', response.status);
                } catch (httpError) {
                    console.error('‚ùå HTTP server not responding:', httpError);
                    showStatus('HTTP server not responding - check if server is running', 'error');
                    return;
                }

                // Test Socket.IO connection (not raw WebSocket)
                const socketUrl = 'http://localhost:8002';
                console.log('üîå Attempting Socket.IO connection to:', socketUrl);

                // Import Socket.IO client for testing
                const script = document.createElement('script');
                script.src = 'https://cdn.socket.io/4.7.5/socket.io.min.js';
                script.onload = () => {
                    const socket = io(socketUrl, {
                        transports: ['websocket', 'polling'],
                        timeout: 5000
                    });

                    socket.on('connect', () => {
                        console.log('‚úÖ Socket.IO connection established successfully');
                        showStatus('Socket.IO connection successful!', 'success');
                        socket.disconnect();
                    });

                    socket.on('connect_error', (error) => {
                        console.error('‚ùå Socket.IO connection failed:', error);
                        showStatus('Socket.IO connection failed - check server configuration', 'error');
                    });

                    socket.on('disconnect', (reason) => {
                        console.log('üîå Socket.IO connection closed:', reason);
                    });
                };
                document.head.appendChild(script);

                // Set a timeout for the Socket.IO connection attempt
                setTimeout(() => {
                    if (!socket.connected) {
                        console.error('‚ùå Socket.IO connection timeout');
                        showStatus('Socket.IO connection timeout - server may not be responding', 'error');
                        socket.disconnect();
                    }
                }, 5000);

            } catch (error) {
                console.error('‚ùå Socket test error:', error);
                showStatus('Socket test failed: ' + error.message, 'error');
            }
        }

        async function testSessionBridge() {
            showStatus('Testing session bridge...', 'info');

            try {
                console.log('üîê Testing session bridge...');

                // Debug: Check all localStorage keys
                console.log('üîç Available localStorage keys:', Object.keys(localStorage));

                // Check for nexus-auth first
                let authData = localStorage.getItem('nexus-auth');
                if (authData) {
                    console.log('‚úÖ Found nexus-auth in localStorage');
                } else {
                    console.log('‚ùå nexus-auth not found in localStorage');
                }

                // Check for Supabase auth keys (sb- prefixed)
                const supabaseKeys = Object.keys(localStorage).filter(k => k.startsWith('sb-'));
                console.log('üîç Supabase auth keys:', supabaseKeys);

                supabaseKeys.forEach(key => {
                    try {
                        const data = localStorage.getItem(key);
                        if (data) {
                            const parsed = JSON.parse(data);
                            console.log(`üîç ${key} content:`, parsed);
                        }
                    } catch (e) {
                        console.warn(`‚ö†Ô∏è Error parsing ${key}:`, e);
                    }
                });

                // Try to get token from any available source
                let token = null;

                // Try nexus-auth first
                if (authData) {
                    try {
                        const parsed = JSON.parse(authData);
                        token = parsed?.currentSession?.access_token ||
                               parsed?.access_token ||
                               parsed?.session?.access_token;
                        if (token) {
                            console.log('‚úÖ Found token from nexus-auth');
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Error parsing nexus-auth:', e);
                    }
                }

                // Try Supabase auth keys if no token found
                if (!token) {
                    for (const key of supabaseKeys) {
                        try {
                            const data = localStorage.getItem(key);
                            if (data) {
                                const parsed = JSON.parse(data);
                                token = parsed?.access_token || parsed?.session?.access_token;
                                if (token) {
                                    console.log(`‚úÖ Found token from ${key}`);
                                    break;
                                }
                            }
                        } catch (e) {
                            console.warn(`‚ö†Ô∏è Error parsing ${key}:`, e);
                        }
                    }
                }

                if (!token) {
                    console.warn('‚ö†Ô∏è No auth token found in any storage location');
                    showStatus('No authentication token found - please ensure you are logged in', 'error');
                    return;
                }

                console.log('üîë Found access token, making session bridge request...');
                const response = await fetch('http://localhost:8002/api/auth/session/bridge', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                if (response.ok) {
                    console.log('‚úÖ Session bridge successful');
                    showStatus('Session bridge successful!', 'success');
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Session bridge failed:', response.status, errorText);
                    showStatus(`Session bridge failed: ${response.status}`, 'error');
                }

            } catch (error) {
                console.error('‚ùå Session bridge test error:', error);
                showStatus('Session bridge test failed: ' + error.message, 'error');
            }
        }

        async function debugAuth() {
            showStatus('Debugging authentication...', 'info');

            try {
                console.log('üîç Debugging authentication state...');

                // Check browser location to see if we're on the right page
                console.log('üìç Current URL:', window.location.href);

                // Check if we're in an iframe or popup that might not have access to localStorage
                console.log('üñºÔ∏è Is in iframe:', window !== window.top);

                // Check all localStorage keys
                console.log('üîç All localStorage keys:', Object.keys(localStorage));

                // Check for authentication-related keys
                const authKeys = Object.keys(localStorage).filter(k =>
                    k.includes('auth') || k.includes('session') || k.startsWith('sb-') || k === 'nexus-auth'
                );
                console.log('üîç Authentication keys found:', authKeys);

                authKeys.forEach(key => {
                    try {
                        const data = localStorage.getItem(key);
                        console.log(`üîç ${key}:`, data ? `${data.substring(0, 100)}...` : 'empty');

                        if (data) {
                            const parsed = JSON.parse(data);
                            console.log(`üîç ${key} parsed:`, parsed);

                            // Look for tokens
                            if (parsed.access_token || parsed.currentSession?.access_token || parsed.session?.access_token) {
                                console.log(`‚úÖ Found token in ${key}`);
                            }
                        }
                    } catch (e) {
                        console.warn(`‚ö†Ô∏è Error parsing ${key}:`, e);
                    }
                });

                // Check if we can access the parent window (if in iframe)
                try {
                    if (window.parent !== window) {
                        console.log('üîç Parent window localStorage keys:', Object.keys(window.parent.localStorage || {}));
                    }
                } catch (e) {
                    console.log('üîç Cannot access parent window (cross-origin)');
                }

                showStatus('Authentication debug complete - check console for details', 'success');

            } catch (error) {
                console.error('‚ùå Debug error:', error);
                showStatus('Debug failed: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
