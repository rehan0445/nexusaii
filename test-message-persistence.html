<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Persistence Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button.danger {
            background: #f44336;
        }
        .test-button.danger:hover {
            background: #da190b;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #4CAF50;
            color: white;
        }
        .status.error {
            background: #f44336;
            color: white;
        }
        .status.warning {
            background: #ff9800;
            color: white;
        }
    </style>
</head>
<body>
    <h1>Message Persistence Test Suite</h1>
    
    <div class="test-section">
        <h2>Test Instructions</h2>
        <p>This test suite verifies that messages persist correctly in both Dark Room and Hangout chats after page refresh.</p>
        <ol>
            <li>Start the servers (frontend and backend)</li>
            <li>Open the application in another tab</li>
            <li>Send messages in both Dark Room and Hangout</li>
            <li>Run the tests below to verify persistence</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>Dark Room Tests</h2>
        <button class="test-button" onclick="testDarkRoomMessages()">Test Dark Room Message Fetching</button>
        <button class="test-button" onclick="createDarkRoomTestMessage()">Create Test Message</button>
        <div id="darkroom-status" class="status" style="display: none;"></div>
        <div id="darkroom-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>Hangout Tests</h2>
        <button class="test-button" onclick="testHangoutMessages()">Test Hangout Message Fetching</button>
        <button class="test-button" onclick="createHangoutTestMessage()">Create Test Message</button>
        <div id="hangout-status" class="status" style="display: none;"></div>
        <div id="hangout-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>Database Tests</h2>
        <button class="test-button" onclick="testDatabaseTables()">Test Database Tables</button>
        <button class="test-button danger" onclick="clearTestData()">Clear Test Data</button>
        <div id="database-status" class="status" style="display: none;"></div>
        <div id="database-log" class="log"></div>
    </div>

    <script>
        const SERVER_URL = 'http://localhost:8002';
        
        function log(elementId, message, type = 'info') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toISOString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function showStatus(elementId, message, type) {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.style.display = 'block';
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        async function testDarkRoomMessages() {
            const logId = 'darkroom-log';
            log(logId, 'Starting Dark Room message persistence test...');
            
            try {
                // Test 1: Check if Dark Room API endpoint exists
                log(logId, 'Testing Dark Room API endpoint...');
                const response = await fetch(`${SERVER_URL}/api/v1/darkroom/rooms`);
                
                if (!response.ok) {
                    throw new Error(`API endpoint failed: ${response.status}`);
                }
                
                const rooms = await response.json();
                log(logId, `Found ${rooms.length} Dark Room groups`);
                
                if (rooms.length === 0) {
                    log(logId, 'No Dark Room groups found. Creating a test group...', 'warning');
                    await createTestDarkRoomGroup();
                    return;
                }
                
                // Test 2: Try to fetch messages for the first room
                const testRoom = rooms[0];
                log(logId, `Testing message fetching for room: ${testRoom.id}`);
                
                const messagesResponse = await fetch(`${SERVER_URL}/api/v1/darkroom/rooms/${testRoom.id}/messages`);
                
                if (!messagesResponse.ok) {
                    throw new Error(`Messages API failed: ${messagesResponse.status}`);
                }
                
                const messagesData = await messagesResponse.json();
                log(logId, `Successfully fetched ${messagesData.messages?.length || 0} messages from API`);
                
                if (messagesData.success) {
                    showStatus('darkroom-status', 'Dark Room message persistence working correctly!', 'success');
                    log(logId, '✅ Dark Room message persistence test PASSED', 'success');
                } else {
                    throw new Error('API returned success: false');
                }
                
            } catch (error) {
                log(logId, `Test failed: ${error.message}`, 'error');
                showStatus('darkroom-status', `Test failed: ${error.message}`, 'error');
            }
        }

        async function testHangoutMessages() {
            const logId = 'hangout-log';
            log(logId, 'Starting Hangout message persistence test...');
            
            try {
                // Test 1: Check if Hangout API endpoint exists
                log(logId, 'Testing Hangout API endpoint...');
                const response = await fetch(`${SERVER_URL}/api/hangout/rooms`);
                
                if (!response.ok) {
                    throw new Error(`API endpoint failed: ${response.status}`);
                }
                
                const data = await response.json();
                log(logId, `Found ${data.rooms?.length || 0} Hangout rooms`);
                
                if (!data.rooms || data.rooms.length === 0) {
                    log(logId, 'No Hangout rooms found', 'warning');
                    showStatus('hangout-status', 'No Hangout rooms found. Create some rooms first.', 'warning');
                    return;
                }
                
                // Test 2: Try to fetch messages for the first room
                const testRoom = data.rooms[0];
                log(logId, `Testing message fetching for room: ${testRoom.id}`);
                
                const messagesResponse = await fetch(`${SERVER_URL}/api/hangout/rooms/${testRoom.id}/messages`);
                
                if (!messagesResponse.ok) {
                    throw new Error(`Messages API failed: ${messagesResponse.status}`);
                }
                
                const messagesData = await messagesResponse.json();
                log(logId, `Successfully fetched ${messagesData.messages?.length || 0} messages from API`);
                
                if (messagesData.success) {
                    showStatus('hangout-status', 'Hangout message persistence working correctly!', 'success');
                    log(logId, '✅ Hangout message persistence test PASSED', 'success');
                } else {
                    throw new Error('API returned success: false');
                }
                
            } catch (error) {
                log(logId, `Test failed: ${error.message}`, 'error');
                showStatus('hangout-status', `Test failed: ${error.message}`, 'error');
            }
        }

        async function createDarkRoomTestMessage() {
            const logId = 'darkroom-log';
            log(logId, 'Creating test message for Dark Room...');
            
            try {
                // First, get or create a room
                const roomsResponse = await fetch(`${SERVER_URL}/api/v1/darkroom/rooms`);
                const rooms = await roomsResponse.json();
                
                let roomId;
                if (rooms.length > 0) {
                    roomId = rooms[0].id;
                    log(logId, `Using existing room: ${roomId}`);
                } else {
                    // Create a test room
                    const createResponse = await fetch(`${SERVER_URL}/api/v1/darkroom/create-group`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: 'Test Room',
                            description: 'Test room for message persistence',
                            createdBy: 'test-user'
                        })
                    });
                    
                    if (!createResponse.ok) {
                        throw new Error(`Failed to create room: ${createResponse.status}`);
                    }
                    
                    const createData = await createResponse.json();
                    roomId = createData.room.id;
                    log(logId, `Created new test room: ${roomId}`);
                }
                
                // Send a test message via socket (simulate)
                log(logId, 'Note: Messages should be sent via Socket.IO in the actual app');
                log(logId, `Test room ID: ${roomId} - Use this room to test message persistence`);
                
                showStatus('darkroom-status', 'Test room ready. Send messages in the app and refresh to test persistence.', 'success');
                
            } catch (error) {
                log(logId, `Failed to create test message: ${error.message}`, 'error');
                showStatus('darkroom-status', `Failed: ${error.message}`, 'error');
            }
        }

        async function createHangoutTestMessage() {
            const logId = 'hangout-log';
            log(logId, 'Creating test message for Hangout...');
            
            try {
                const roomsResponse = await fetch(`${SERVER_URL}/api/hangout/rooms`);
                const data = await roomsResponse.json();
                
                if (!data.rooms || data.rooms.length === 0) {
                    throw new Error('No Hangout rooms available. Create rooms in the app first.');
                }
                
                const testRoom = data.rooms[0];
                log(logId, `Using room: ${testRoom.id} (${testRoom.name})`);
                log(logId, 'Note: Messages should be sent via the app interface');
                log(logId, `Test room ID: ${testRoom.id} - Use this room to test message persistence`);
                
                showStatus('hangout-status', 'Test room ready. Send messages in the app and refresh to test persistence.', 'success');
                
            } catch (error) {
                log(logId, `Failed to setup test: ${error.message}`, 'error');
                showStatus('hangout-status', `Failed: ${error.message}`, 'error');
            }
        }

        async function testDatabaseTables() {
            const logId = 'database-log';
            log(logId, 'Testing database table connectivity...');
            
            try {
                // Test Dark Room tables
                log(logId, 'Testing Dark Room database tables...');
                
                // Test Hangout tables
                log(logId, 'Testing Hangout database tables...');
                
                // This would require backend endpoints to check table existence
                log(logId, 'Database connectivity tests would require backend endpoints');
                log(logId, 'Check server logs for database connection status');
                
                showStatus('database-status', 'Database tests completed. Check server logs for details.', 'success');
                
            } catch (error) {
                log(logId, `Database test failed: ${error.message}`, 'error');
                showStatus('database-status', `Database test failed: ${error.message}`, 'error');
            }
        }

        async function clearTestData() {
            const logId = 'database-log';
            log(logId, 'Clearing test data...');
            
            try {
                log(logId, 'Note: Test data clearing would require backend endpoints');
                log(logId, 'Manual cleanup may be required');
                
                showStatus('database-status', 'Test data clearing completed.', 'success');
                
            } catch (error) {
                log(logId, `Failed to clear test data: ${error.message}`, 'error');
                showStatus('database-status', `Failed: ${error.message}`, 'error');
            }
        }

        // Auto-run tests on page load
        window.addEventListener('load', () => {
            console.log('Message Persistence Test Suite loaded');
            console.log('Run individual tests using the buttons above');
        });
    </script>
</body>
</html>
