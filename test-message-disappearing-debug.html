<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Disappearing Debug Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            background: #000;
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
        }
        h2 {
            color: #00ffff;
            margin-top: 0;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #444;
            font-size: 12px;
        }
        .log-entry.error { border-left-color: #ff0000; color: #ff6666; }
        .log-entry.warn { border-left-color: #ffaa00; color: #ffcc66; }
        .log-entry.info { border-left-color: #0088ff; color: #66bbff; }
        .log-entry.success { border-left-color: #00ff00; color: #66ff66; }
        .metric {
            background: #222;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .metric-label {
            color: #888;
            font-size: 11px;
        }
        .metric-value {
            color: #fff;
            font-size: 24px;
            font-weight: bold;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
        }
        button:hover {
            background: #00cc00;
        }
        .timeline {
            background: #111;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        .api-call {
            background: #1a2a3a;
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            border-left: 4px solid #0088ff;
        }
    </style>
</head>
<body>
    <h1>üîç Message Disappearing Debug Test</h1>
    <p>This test monitors console logs and tracks message state changes in real-time.</p>
    
    <div style="margin: 20px 0;">
        <button onclick="clearLogs()">Clear Logs</button>
        <button onclick="exportLogs()">Export Logs</button>
        <button onclick="simulateRoomSwitch()">Simulate Room Switch</button>
        <button onclick="checkCurrentState()">Check Current State</button>
    </div>

    <div class="container">
        <div class="panel">
            <h2>üìä Real-Time Metrics</h2>
            <div class="metric">
                <div class="metric-label">Context Message Count</div>
                <div class="metric-value" id="contextCount">-</div>
            </div>
            <div class="metric">
                <div class="metric-label">Local Message Count (UI)</div>
                <div class="metric-value" id="localCount">-</div>
            </div>
            <div class="metric">
                <div class="metric-label">API Calls Made</div>
                <div class="metric-value" id="apiCalls">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">State Updates</div>
                <div class="metric-value" id="stateUpdates">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">Messages Cleared Count</div>
                <div class="metric-value" id="clearedCount">0</div>
            </div>
        </div>

        <div class="panel">
            <h2>üïí API Call Timeline</h2>
            <div class="timeline" id="apiTimeline"></div>
        </div>
    </div>

    <div class="panel" style="margin-top: 20px;">
        <h2>üìù Live Console Logs</h2>
        <div id="logs" style="max-height: 400px; overflow-y: auto;"></div>
    </div>

    <script>
        let apiCallCount = 0;
        let stateUpdateCount = 0;
        let clearedCount = 0;
        let logs = [];

        // Override console methods to capture logs
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;

        function addLog(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logEntry = { message, type, timestamp };
            logs.push(logEntry);

            const logsDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp.split('T')[1].split('.')[0]}] ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;

            // Parse and update metrics
            if (message.includes('[MSG_PERSISTENCE_API]') || message.includes('[SELECT_ROOM] Calling')) {
                apiCallCount++;
                document.getElementById('apiCalls').textContent = apiCallCount;
                addAPICall(message);
            }

            if (message.includes('[CONTEXT_MESSAGES_UPDATE]')) {
                stateUpdateCount++;
                document.getElementById('stateUpdates').textContent = stateUpdateCount;
                
                // Try to extract counts from the log
                const match = message.match(/newCount[:\s]+(\d+)/);
                if (match) {
                    document.getElementById('contextCount').textContent = match[1];
                }
            }

            if (message.includes('[HANGOUT_CHAT_SYNC]') && message.includes('localMessagesCount')) {
                const match = message.match(/localMessagesCount[:\s]+(\d+)/);
                if (match) {
                    document.getElementById('localCount').textContent = match[1];
                }
            }

            if (message.includes('ALL MESSAGES CLEARED')) {
                clearedCount++;
                document.getElementById('clearedCount').textContent = clearedCount;
            }
        }

        function addAPICall(message) {
            const timeline = document.getElementById('apiTimeline');
            const call = document.createElement('div');
            call.className = 'api-call';
            call.innerHTML = `
                <div style="color: #66bbff; font-size: 11px;">${new Date().toLocaleTimeString()}</div>
                <div style="color: #fff; font-size: 12px; margin-top: 3px;">${message.substring(0, 100)}</div>
            `;
            timeline.appendChild(call);
            timeline.scrollTop = timeline.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
            ).join(' ');
            addLog(message, 'info');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
            ).join(' ');
            addLog(message, 'warn');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
            ).join(' ');
            addLog(message, 'error');
        };

        function clearLogs() {
            logs = [];
            document.getElementById('logs').innerHTML = '';
            apiCallCount = 0;
            stateUpdateCount = 0;
            clearedCount = 0;
            document.getElementById('apiCalls').textContent = '0';
            document.getElementById('stateUpdates').textContent = '0';
            document.getElementById('clearedCount').textContent = '0';
            document.getElementById('apiTimeline').innerHTML = '';
            addLog('Logs cleared', 'info');
        }

        function exportLogs() {
            const dataStr = JSON.stringify(logs, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `message-debug-logs-${Date.now()}.json`;
            link.click();
            addLog('Logs exported', 'success');
        }

        function simulateRoomSwitch() {
            addLog('üîÑ USER ACTION: Simulating room switch...', 'info');
            setTimeout(() => {
                addLog('Check the app for room switch behavior', 'info');
            }, 100);
        }

        function checkCurrentState() {
            addLog('üîç Checking current application state...', 'info');
            addLog('Open browser DevTools ‚Üí Application ‚Üí Local Storage to see stored data', 'info');
            addLog('Check Redux DevTools or React DevTools for state inspection', 'info');
        }

        // Initial message
        addLog('üöÄ Debug monitor started. Open your hangout room to see logs.', 'success');
        addLog('üìå Watch for patterns: How many times is loadMessages called? When do messages clear?', 'info');
    </script>
</body>
</html>

