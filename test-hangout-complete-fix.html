<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hangout Complete Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .user-panel {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .messages {
            height: 300px;
            overflow-y: auto;
            background: #1a1a1a;
            border: 1px solid #444;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .message {
            margin: 5px 0;
            padding: 8px;
            background: #333;
            border-radius: 4px;
        }
        .message.sent {
            background: #0066cc;
        }
        .message.received {
            background: #cc6600;
        }
        input, button {
            padding: 8px;
            margin: 5px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #333;
            color: #fff;
        }
        button {
            background: #0066cc;
            cursor: pointer;
        }
        button:hover {
            background: #0052a3;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected {
            background: #2d5a2d;
            color: #90ee90;
        }
        .status.disconnected {
            background: #5a2d2d;
            color: #ee9090;
        }
        .log {
            background: #1a1a1a;
            border: 1px solid #444;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .test-button {
            background: #28a745;
            margin: 5px;
        }
        .test-button:hover {
            background: #218838;
        }
        .refresh-button {
            background: #ffc107;
            color: #000;
        }
        .refresh-button:hover {
            background: #e0a800;
        }
    </style>
</head>
<body>
    <h1>üß™ Hangout Complete Fix Test</h1>
    <p>This page tests both room creation fixes and message persistence after refresh.</p>
    
    <div class="test-section">
        <h2>üéØ Test Scenarios</h2>
        <button class="test-button" onclick="testRoomCreation()">Test Room Creation</button>
        <button class="test-button" onclick="testMessagePersistence()">Test Message Persistence</button>
        <button class="refresh-button" onclick="simulateRefresh()">Simulate Page Refresh</button>
        <button class="test-button" onclick="clearAllData()">Clear All Data</button>
    </div>
    
    <div class="container">
        <!-- User 1 Panel -->
        <div class="user-panel">
            <h2>üë§ User 1</h2>
            <div class="status disconnected" id="status1">Disconnected</div>
            <div>
                <input type="text" id="roomId1" placeholder="Room ID" value="test-room-123">
                <button onclick="connectUser1()">Connect</button>
                <button onclick="joinRoom1()">Join Room</button>
            </div>
            <div>
                <input type="text" id="message1" placeholder="Type message...">
                <button onclick="sendMessage1()">Send</button>
            </div>
            <div class="messages" id="messages1"></div>
            <div class="log" id="log1"></div>
        </div>

        <!-- User 2 Panel -->
        <div class="user-panel">
            <h2>üë§ User 2</h2>
            <div class="status disconnected" id="status2">Disconnected</div>
            <div>
                <input type="text" id="roomId2" placeholder="Room ID" value="test-room-123">
                <button onclick="connectUser2()">Connect</button>
                <button onclick="joinRoom2()">Join Room</button>
            </div>
            <div>
                <input type="text" id="message2" placeholder="Type message...">
                <button onclick="sendMessage2()">Send</button>
            </div>
            <div class="messages" id="messages2"></div>
            <div class="log" id="log2"></div>
        </div>
    </div>

    <div class="test-section">
        <h3>üéØ Test Instructions</h3>
        <ol>
            <li><strong>Test Room Creation:</strong> Click "Test Room Creation" to verify room creation works</li>
            <li><strong>Connect Both Users:</strong> Click "Connect" for both User 1 and User 2</li>
            <li><strong>Join Same Room:</strong> Make sure both users have the same Room ID, then click "Join Room" for both</li>
            <li><strong>Send Messages:</strong> Type messages in either user's input and click "Send"</li>
            <li><strong>Test Persistence:</strong> Click "Simulate Page Refresh" to test message persistence</li>
            <li><strong>Verify Results:</strong> Messages should persist after refresh and be visible to both users</li>
        </ol>
        
        <h3>‚úÖ Expected Results</h3>
        <ul>
            <li>Room creation should work without "failed to create room" errors</li>
            <li>Both users should show "Connected" status</li>
            <li>Messages sent by User 1 should appear in User 2's messages</li>
            <li>Messages sent by User 2 should appear in User 1's messages</li>
            <li>Messages should persist after page refresh</li>
            <li>Logs should show successful joins and message events</li>
        </ul>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let socket1 = null;
        let socket2 = null;
        let currentRoom1 = null;
        let currentRoom2 = null;
        let testRoomId = null;

        function log(user, message) {
            const logElement = document.getElementById(`log${user}`);
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(user, connected) {
            const statusElement = document.getElementById(`status${user}`);
            statusElement.textContent = connected ? 'Connected' : 'Disconnected';
            statusElement.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }

        function addMessage(user, message, isSent = false) {
            const messagesElement = document.getElementById(`messages${user}`);
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            messageDiv.innerHTML = `<strong>${message.userName || 'User'}:</strong> ${message.content}`;
            messagesElement.appendChild(messageDiv);
            messagesElement.scrollTop = messagesElement.scrollHeight;
        }

        function clearMessages(user) {
            const messagesElement = document.getElementById(`messages${user}`);
            messagesElement.innerHTML = '';
        }

        // Test room creation
        async function testRoomCreation() {
            try {
                log(1, 'üèóÔ∏è Testing room creation...');
                const response = await fetch('http://localhost:8002/api/hangout/rooms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer test-token'
                    },
                    body: JSON.stringify({
                        name: `Test Room ${Date.now()}`,
                        description: 'Test room for message persistence',
                        category: 'Test',
                        createdBy: 'test-user-1'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    testRoomId = result.room.id;
                    log(1, `‚úÖ Room created successfully: ${testRoomId}`);
                    document.getElementById('roomId1').value = testRoomId;
                    document.getElementById('roomId2').value = testRoomId;
                } else {
                    log(1, `‚ùå Room creation failed: ${result.message}`);
                }
            } catch (error) {
                log(1, `‚ùå Room creation error: ${error.message}`);
            }
        }

        // Test message persistence
        async function testMessagePersistence() {
            log(1, 'üìö Testing message persistence...');
            if (!currentRoom1) {
                log(1, '‚ùå Not in a room');
                return;
            }

            // Send a test message
            const testMessage = `Persistence test message ${Date.now()}`;
            socket1.emit('send-hangout-message', {
                roomId: currentRoom1,
                userId: 'test-user-1',
                content: testMessage,
                userName: 'Test User 1'
            });
            log(1, `üì§ Sent persistence test message: ${testMessage}`);
        }

        // Simulate page refresh
        function simulateRefresh() {
            log(1, 'üîÑ Simulating page refresh...');
            log(2, 'üîÑ Simulating page refresh...');
            
            // Clear messages (simulate refresh)
            clearMessages(1);
            clearMessages(2);
            
            // Rejoin rooms to test persistence
            if (currentRoom1) {
                setTimeout(() => {
                    log(1, 'üîÑ Rejoining room after refresh...');
                    joinRoom1();
                }, 1000);
            }
            
            if (currentRoom2) {
                setTimeout(() => {
                    log(2, 'üîÑ Rejoining room after refresh...');
                    joinRoom2();
                }, 1500);
            }
        }

        // Clear all data
        function clearAllData() {
            clearMessages(1);
            clearMessages(2);
            log(1, 'üóëÔ∏è Cleared all data');
            log(2, 'üóëÔ∏è Cleared all data');
            currentRoom1 = null;
            currentRoom2 = null;
            testRoomId = null;
        }

        function connectUser1() {
            if (socket1) {
                socket1.disconnect();
            }

            socket1 = io('http://localhost:8002', {
                auth: {
                    token: 'test-token-1',
                    userId: 'test-user-1'
                }
            });

            socket1.on('connect', () => {
                updateStatus(1, true);
                log(1, '‚úÖ Connected to server');
            });

            socket1.on('disconnect', () => {
                updateStatus(1, false);
                log(1, '‚ùå Disconnected from server');
            });

            socket1.on('receive-hangout-message', (message) => {
                log(1, `üì® Received message: ${message.content}`);
                addMessage(1, message, false);
            });

            socket1.on('hangout-room-history', (messages) => {
                log(1, `üìö Received ${messages.length} historical messages`);
                messages.forEach(msg => addMessage(1, msg, false));
            });

            socket1.on('error', (error) => {
                log(1, `‚ùå Error: ${error.message}`);
            });
        }

        function connectUser2() {
            if (socket2) {
                socket2.disconnect();
            }

            socket2 = io('http://localhost:8002', {
                auth: {
                    token: 'test-token-2',
                    userId: 'test-user-2'
                }
            });

            socket2.on('connect', () => {
                updateStatus(2, true);
                log(2, '‚úÖ Connected to server');
            });

            socket2.on('disconnect', () => {
                updateStatus(2, false);
                log(2, '‚ùå Disconnected from server');
            });

            socket2.on('receive-hangout-message', (message) => {
                log(2, `üì® Received message: ${message.content}`);
                addMessage(2, message, false);
            });

            socket2.on('hangout-room-history', (messages) => {
                log(2, `üìö Received ${messages.length} historical messages`);
                messages.forEach(msg => addMessage(2, msg, false));
            });

            socket2.on('error', (error) => {
                log(2, `‚ùå Error: ${error.message}`);
            });
        }

        function joinRoom1() {
            if (!socket1 || !socket1.connected) {
                log(1, '‚ùå Not connected to server');
                return;
            }

            const roomId = document.getElementById('roomId1').value;
            if (!roomId) {
                log(1, '‚ùå Please enter a room ID');
                return;
            }

            currentRoom1 = roomId;
            socket1.emit('join-hangout-room', {
                roomId: roomId,
                userId: 'test-user-1'
            });

            log(1, `üè† Joining room: ${roomId}`);
        }

        function joinRoom2() {
            if (!socket2 || !socket2.connected) {
                log(2, '‚ùå Not connected to server');
                return;
            }

            const roomId = document.getElementById('roomId2').value;
            if (!roomId) {
                log(2, '‚ùå Please enter a room ID');
                return;
            }

            currentRoom2 = roomId;
            socket2.emit('join-hangout-room', {
                roomId: roomId,
                userId: 'test-user-2'
            });

            log(2, `üè† Joining room: ${roomId}`);
        }

        function sendMessage1() {
            if (!socket1 || !socket1.connected) {
                log(1, '‚ùå Not connected to server');
                return;
            }

            if (!currentRoom1) {
                log(1, '‚ùå Not in a room');
                return;
            }

            const messageInput = document.getElementById('message1');
            const content = messageInput.value.trim();
            if (!content) {
                log(1, '‚ùå Please enter a message');
                return;
            }

            const message = {
                roomId: currentRoom1,
                userId: 'test-user-1',
                content: content,
                userName: 'Test User 1'
            };

            socket1.emit('send-hangout-message', message);
            addMessage(1, message, true);
            messageInput.value = '';
            log(1, `üì§ Sent message: ${content}`);
        }

        function sendMessage2() {
            if (!socket2 || !socket2.connected) {
                log(2, '‚ùå Not connected to server');
                return;
            }

            if (!currentRoom2) {
                log(2, '‚ùå Not in a room');
                return;
            }

            const messageInput = document.getElementById('message2');
            const content = messageInput.value.trim();
            if (!content) {
                log(2, '‚ùå Please enter a message');
                return;
            }

            const message = {
                roomId: currentRoom2,
                userId: 'test-user-2',
                content: content,
                userName: 'Test User 2'
            };

            socket2.emit('send-hangout-message', message);
            addMessage(2, message, true);
            messageInput.value = '';
            log(2, `üì§ Sent message: ${content}`);
        }

        // Allow Enter key to send messages
        document.getElementById('message1').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage1();
            }
        });

        document.getElementById('message2').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage2();
            }
        });
    </script>
</body>
</html>
